# 데이터베이스 설계
JPA와 MySQL을 사용하여 프로젝트에 필요한 데이터베이스 스터디 자료를 정리해보자. <br>

### 목차
목차는 다음과 같습니다.
+ 테이블 설계에서의 기본 키와 외래 키: 중복과 데이터 일관성의 중요성
+ 예시 : User 테이블 생성 SQL문 작성
+ 예시 : 더미 데이터 SQL 작성

## ✅ 테이블 설계에서의 기본 키와 외래 키: 중복과 데이터 일관성의 중요성

아래의 사진처럼 item_id, room_id 등등 PK는 같은 값을 가질 수 없어요. <br>
![문제](https://github.com/StudyHunter/Backend/assets/57389368/9d8a89aa-fd7b-455b-a64c-a666205a8a61)

일반적으로 데이터베이스에서 특정 테이블의 기본 키 (Primary Key)는 중복되지 않아야 한다.  <br>
따라서 room_id와 item_id는 동일한 값을 가질 수 없다. 기본 키 제약 조건은 테이블 내에서 각 행을 고유하게 식별하기 위해 사용된다. <br><br>
테이블에서 room_id가 기본 키로 설정되어 있으므로 room_id 열의 값은 모든 행에서 고유해야 한다. <br>
item_id 열은 일반적으로 외래 키로 사용되고, 다른 테이블의 기본 키와 연결되어 있는 경우가 많다. <br> <br>
따라서 room_id와 user_id가 동일한 값을 가질 수 있게 하는 것은 일반적인 설계 패턴이 아니며, 데이터의 무결성과 일관성을 위배할 수 있다. <br><br>
아래의 사진처럼 PK값은 구별되어야 한다. <br>
![image](https://github.com/StudyHunter/Backend/assets/57389368/f1599e7c-61e4-4013-8c17-7bdae9580f39)

## ✅ 예시 : User 테이블 생성 SQL문 작성
JPA를 사용하여 User에 대해 설계했을 때, MySQL에 테이블 생성 SQL을 어떻게 작성해야 하는지 정리해보자. <br>

### User Entity
```java
@Table(name = "USERS")
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Entity
public class User extends UserBase {

    private String nickname; // 닉네임

    private int studyTime; // 총 공부 시간

    @Enumerated(EnumType.STRING)
    private UserStatus userStatus;

    @Enumerated(EnumType.STRING)
    private List<TagOption> tags = new ArrayList<>(); // 취향저장

    private int wishGroupSize; //원하는 조건 : 인원/기간
    private int wishExpectedSchedule;
```

```java
package inf.questpartner.domain.users.common;

import inf.questpartner.domain.BaseTimeEntity;
import jakarta.persistence.*;

import lombok.AccessLevel;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;

/**
 * UserBase는 User 테이블에 필요한 공통 사항을 정의한다.
 * (로그인 정보) 이메일 / 패스워드
 * 회원 권한구분 (User_Level)
 */

@Entity
@Getter
@Inheritance(strategy = InheritanceType.JOINED)
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
@DiscriminatorColumn
public abstract class UserBase extends BaseTimeEntity {

    @Id
    @GeneratedValue
    @Column(name = "USER_ID")
    private Long id;

    @Column(unique = true)
    protected String email;
    protected String password;

    @Enumerated(EnumType.STRING)
    protected UserLevel userLevel;


}
```

<br>

### SQL 작성 : Create Table
MySQL에는 다음과 같이 SQL을 작성하면 된다. <br>
```
create table user_base (
        created_date timestamp(6),
        modified_date timestamp(6),
        user_id bigint not null,
        dtype varchar(31) not null,
        email varchar(255) unique,
        password varchar(255),
        user_level varchar(255) check (user_level in ('UNAUTH','AUTH','ADMIN')),
        primary key (user_id)
);

create table users (
        study_time integer not null,
        wish_expected_schedule integer not null,
        wish_group_size integer not null,
        study_tree_id bigint unique,
        user_id bigint not null,
        user_profile_img_id bigint unique,
        nickname varchar(255),
        user_status varchar(255) check (user_status in ('NORMAL','BAN')),
        tags json, 
        primary key (user_id)
);
```

위의 sql문에서 중요한 포인트는 다음과 같다. <br>
+ tags(List<TagOption)열은 JSON 형식으로 데이터를 저장할 수 있다.
+ user_level, user_status 열은 주어진 Enum 값을 받을 수 있도록 CHECK 제약 조건이 추가되어 있다.

  
##  ✅ 예시 : 더미 데이터 SQL 작성
아래는 주어진 두 개의 테이블에 대한 더미 데이터를 삽입하는 SQL 문이다. <br>

### insert SQL 작성
#### `1` user_base
```
INSERT INTO user_base (created_date, modified_date, user_id, dtype, email, password, user_level)
VALUES ('2024-01-29 12:00:00', '2024-01-29 14:30:00', 1, 'User', 'user1@example.com', 'password123', 'AUTH'),
       ('2024-01-29 13:30:00', '2024-01-29 15:45:00', 2, 'Admin', 'admin@example.com', 'adminpass', 'ADMIN'),
       ('2024-01-29 14:45:00', '2024-01-29 16:00:00', 3, 'User', 'user2@example.com', 'userpass', 'UNAUTH');
```

#### `2` users
```
INSERT INTO users (study_time, wish_expected_schedule, wish_group_size, study_tree_id, user_id, user_profile_img_id, nickname, user_status, tags) VALUES
    (120, 5, 3, 101, 1, 201, 'User1', 'NORMAL', '["tag1", "tag2"]'),
    (180, 7, 4, 102, 2, 202, 'AdminUser', 'BAN', '["tag3", "tag4"]'),
    (90, 4, 2, 103, 3, 203, 'User2', 'NORMAL', '["tag5", "tag6"]');
```

<br><br><br>

### select SQL 작성
다음과 같이 조회할 수 있다. <br>

#### `1` SELECT * FROM test.user_base;
![image](https://github.com/StudyHunter/Backend/assets/57389368/56645ed6-b79f-4a74-a9e2-117329f9eda2)

<br>

#### `2` SELECT * FROM test.users;
![image](https://github.com/StudyHunter/Backend/assets/57389368/73deb1aa-6316-41d8-bfe4-b418bf661912)


